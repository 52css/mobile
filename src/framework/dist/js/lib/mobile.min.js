/**
 * Created by Ivan on 15-4-16.
 *
 * Version: 0.0.1
 *
 */define(function(){var e={history:[],index:-1},t=!1,a={slice:[].slice,isJSON:function(e){return/^[\],:{}\s]*$/.test(e.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))?!0:!1},makeArray:function(e){var t=[];if(null!==e){var a=e.length;if(null==a||e.split||e.setInterval||e.call)t[0]=e;else for(;a;)t[--a]=e[a]}return t},closestByFilter:function(e,t){for(var a=e.parentNode;a;){if("body"===a.tagName.toLowerCase())return null;var n=t(a);if(n)return n;a=a.parentNode}},closest:function(e,t){return a.closestByFilter(e,function(e){return t&&e.tagName.toLowerCase()===t.toLowerCase()?e:void 0})},siblings:function(e){function t(e,t){for(var a=[];e;e=e.nextSibling)1==e.nodeType&&e!=t&&a.push(e);return a}return t(e.parentNode.firstChild,e)},ajax:function(e,t,a){function n(e){var t=new XMLHttpRequest,a=(e.method||"get").toUpperCase(),n=e.url||"",i=e.beforeSend||function(){},r=e.success||function(){},s=e.timeout||1e5,l=e.dataType||"text",o=e.error||function(){},c=e.data||null,u=e.sync||!0,d=e.complete||function(){},f=function(a){e.message=a,o.call(e,t,t.status)};i.call(e,t),t.onload=function(){var a=t.responseText;if(200===t.status)switch(l){case"json":try{r.call(e,JSON.parse(a))}catch(n){f("JSON parse errorï¼š"+n.message)}break;case"text":r.call(e,a)}else f("The status code exception!");d.call(e,t,a)},"POST"==a&&t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onerror=function(e){f("Illegal request address or an unexpected network error!")},t.ontimeout=function(){f("The request timeout!")},t.open(a,n,u),t.timeout=s,t.send(c)}var i,r=0,s={};Array.isArray(e)||(e=[e]),i=e.length,l.style.visibility="visible",e.forEach(function(e){var o=e.success,c=e.error;e.success=function(t){o&&o.apply(e,arguments),s[e.url]=t},e.error=function(){c&&c.apply(e,arguments),s[e.url]={}},e.complete=function(){r++,r===i&&(t&&t(s),a||(l.style.visibility="hidden"))},n(e)})},getState:function(e){var t,a,n={};return e=e||location.hash,/^#\w+/.test(e)?(n.action="anchor",n.anchor=e.slice(1)):/^#!\//.test(e)?(n.url=e,n.action="pageId",e=e.slice(3),t=e.split("?"),t[0]&&(n.pageId=t[0],n.href=n.pageId+".html"+(t[1]?"?"+t[1]:"")),t[1]&&(a=t[1].split("#"),a[0].replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,t,a,i){n.query[t]=unescape(i)}),a[1]&&(n.anchor=t[1]))):(n.action="pageUrl",n.pageUrl=e,t=e.split("?"),n.pageName=t[0],t[0]&&(n.pageId=t[0].split(".").slice(0,-1).join("."),n.url="#!/"+n.pageId+(t[1]?"?"+t[1]:"")),t[1]&&(a=t[1].split("#"),a[0].replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,t,a,i){n.query[t]=unescape(i)}),a[1]&&(n.anchor=t[1]))),n},replaceState:function(e,t,a){t=t||e.title,document.title=t,a=a||e.url,history.replaceState(e,t,a)},pushState:function(e,t,a){t=t||e.title,document.title=t,a=a||e.url,history.pushState(e,t,a)},switchPage:function(t,i,r,s){t.time=new Date;var l=e.history[e.index],c=document.getElementById(l),u=document.getElementById(i);f.pageOut.forEach(function(e){(e.pageName===l||void 0===e.pageName||null===e.pageName)&&e.callback(c)}),n&&(n.innerHTML=u.getAttribute("data-title")),s=s||!1,u.style.visibility="visible",c.style.visibility="visible",c.classList.add("out"),c.classList.add(c.getAttribute("data-classname")||"slide"),c.classList.remove("in"),u.classList.remove("out"),u.classList.add("in"),u.classList.add(u.getAttribute("data-classname")||"slide"),t.title=u.getAttribute("data-title");var d=o.some(function(e){return e.pageId===i?e:void 0});d||f.pageFirstInit.forEach(function(e){(e.pageName===i||void 0===e.pageName||null===e.pageName)&&e.callback(u)}),f.pageInit.forEach(function(e){(e.pageName===i||void 0===e.pageName||null===e.pageName)&&e.callback(u)}),e.index>r?(c.classList.add("reverse"),u.classList.add("reverse")):(c.classList.remove("reverse"),u.classList.remove("reverse")),s||a.pushState(t),e.index=r,o.push(t)},makeFrag:function(e){var t=document.createDocumentFragment(),n=document.createElement("div");for(n.innerHTML=e;n.firstChild;)t.appendChild(n.firstChild);return e=t,a.makeArray(e)},append:function(e,t){a.makeFrag(t).forEach(function(t){e.appendChild(t)})}},n=document.querySelector("body > header h1"),i=document.getElementsByClassName("page"),r=location.hash,s=r&&a.getState(r),l=function(){var e=document.getElementById("mask");return e||(a.append(document.body,'<div id="mask" class="mask"><i class="fa fa-spinner fa-pulse fa-2x"></i></div>'),e=document.getElementById("mask")),e}(),o=[],c=function(){var e=this,t=e.id,a=e.getAttribute("data-classname");e.classList.remove(a),e.classList.contains("in")?f.pageAfterAnimate.forEach(function(a){(a.pageName===t||void 0===a.pageName||null===a.pageName)&&a.callback(e)}):e.style.visibility="hidden"},u=function(){var e=this,t=e.id;e.classList.contains("in")&&f.pageBeforeAnimate.forEach(function(a){(a.pageName===t||void 0===a.pageName||null===a.pageName)&&a.callback(e)})},d=function(e,t){t(e)},f={ajaxRender:[],pageFirstInit:[],pageInit:[],pageBeforeAnimate:[],pageAfterAnimate:[],pageOut:[]},g={pageRule:"#!/",hashRule:"#",pageUrlRule:"",pageClassName:"slide",on:function(e,t,a){var n=arguments;2===n.length&&(a=t,t=null);var i=e.split("."),r=i[0],s=i[1];return f[r].push({key:s,pageName:t,callback:a}),g},off:function(e){var t=e.split("."),a=t[0],n=t[1];if(a)f[a]=n?f[a].map2(function(e){return e.key===n?null:void 0}):[];else if(n)for(var i in f)f[i]=f[i].forEach(function(e){return e.key===n?null:void 0});return g},ajax:a.ajax,binds:{tabs:function(){document.addEventListener("click",function(e){var t=e.target;if(t&&("a"==t.tagName.toLowerCase()||(t=a.closest(t,"a")))){var n,i=t.getAttribute("href"),r=t.getAttribute("data-rel");if(i&&!/^javascript/.test(i)&&"external"!==r&&(n=a.getState(i),"anchor"===n.action)){t.classList.add("active"),a.siblings(t).forEach(function(e){e.classList.remove("active")});var s=document.querySelector(i);return s.style.visibility="visible",s.style.display="block",a.siblings(s).forEach(function(e){e.style.visibility="hidden",e.style.display="none"}),e.preventDefault()}}})},toggleClass:function(){document.addEventListener("click",function(e){var t=e.target;if(t&&(null!=t.getAttribute("data-toggle-class")&&""!=t.getAttribute("data-toggle-class")||(t=a.closestByFilter(t,function(e){return null!=e.getAttribute("data-toggle-class")&&""!=e.getAttribute("data-toggle-class")?e:void 0})))){var n=t.getAttribute("data-toggle-class");return n?(t.classList.contains(n)?t.classList.remove(n):t.classList.add(n),e.preventDefault()):void 0}})},addClass:function(){document.addEventListener("click",function(e){var t=e.target;if(t&&(null!=t.getAttribute("data-add-class")&&""!=t.getAttribute("data-add-class")||(t=a.closestByFilter(t,function(e){return null!=e.getAttribute("data-add-class")&&""!=e.getAttribute("data-add-class")?e:void 0})))){var n=t.getAttribute("data-add-class");return n?(t.classList.add(n),e.preventDefault()):void 0}})},removeClass:function(){document.addEventListener("click",function(e){var t=e.target;if(t&&(null!=t.getAttribute("data-remove-class")&&""!=t.getAttribute("data-remove-class")||(t=a.closestByFilter(t,function(e){return null!=e.getAttribute("data-remove-class")&&""!=e.getAttribute("data-remove-class")?e:void 0})))){var n=t.getAttribute("data-remove-class");return n?(t.classList.remove(n),e.preventDefault()):void 0}})}},init:function(){t=!0;var n=this,r=function(){a.slice.call(i).forEach(function(t,a){var n=t.id;t.getAttribute("data-title")||t.setAttribute("data-title",document.title),a===e.index?(t.classList.remove("out"),t.classList.add("in"),f.pageFirstInit.forEach(function(e){(e.pageName===n||void 0===e.pageName||null===e.pageName)&&e.callback(t)}),f.pageInit.forEach(function(e){(e.pageName===n||void 0===e.pageName||null===e.pageName)&&e.callback(t)})):(t.classList.remove("in"),t.classList.add("out")),e.history.push(n),t.addEventListener("webkitAnimationEnd",c),t.addEventListener("webkitAnimationStart",u)}),s||(s=a.getState("#!/"+e.history[0])),s.time=new Date,s.title=document.title,o.push(s),a.replaceState(s)};if(Object.keys(n.binds).forEach(function(e){var t=n.binds[e];t()}),s.action&&"anchor"!==s.action)if(a.slice.call(i).forEach(function(t,a){var n=t.id;return n===s.pageId?(e.index=a,!1):void 0}),e.index>=0)r();else{var g=s.pageId;a.ajax({url:s.href,success:function(t){var n=d;f.ajaxRender.forEach(function(e){e.pageName===g?n=e.callback:(void 0===e.pageName||null===e.pageName)&&e.callback(document.getElementById(g))}),n(t,function(t){var n=/<title[^>]*?>([\s\S]*?)<\/title>/.exec(t),s=/<body[^>]*?>([\s\S]*?)<\/body>/.exec(t);n&&(document.title=n[1]),e.index=i.length,a.append(document.body,s?s[1]:t),l.style.visibility="hidden",r()})}},function(){},!0)}else e.index=0,r();return n}};return Array.prototype.map2=function(e){for(var t=[],a=0;a<this.length;a++){var n=e(this[a],a);null!=n&&t.push(n)}return t},window.addEventListener("popstate",function(t){var n,i=t.state,r=i.pageId;e.history.forEach(function(e,t){return e===r?(n=t,!1):void 0}),document.title=i.title,a.switchPage(i,r,n,!0)}),document.addEventListener("click",function(t){var n=t.target;if(n&&("a"==n.tagName.toLowerCase()||(n=a.closest(n,"a")))){var i,r,s,o=n.getAttribute("href"),g=n.getAttribute("data-rel"),p=n.getAttribute("data-reload");if(o&&!/^javascript/.test(o))switch(g){case"external":break;default:if(i=a.getState(o),"anchor"!==i.action)if(r=i.pageId,e.history.forEach(function(e,t){return e===r?(s=t,!1):void 0}),s>-1&&(null==p||"false"==p))a.switchPage(i,r,s);else{var m=document.getElementById(r);m&&m.parentNode.removeChild(m),a.ajax({url:o,success:function(t){var n=d;f.ajaxRender.forEach(function(e){e.pageName===r?n=e.callback:(void 0===e.pageName||null===e.pageName)&&e.callback(document.getElementById(r))}),n(t,function(t){var n=/<title[^>]*?>([\s\S]*?)<\/title>/.exec(t),o=/<body[^>]*?>([\s\S]*?)<\/body>/.exec(t);o=o?o[1]:t,a.append(document.body,o),l.style.visibility="hidden",e.history.push(r),s=e.history.length-1;var d=document.getElementById(r);n&&d.setAttribute("data-title",n[1]),d.addEventListener("webkitAnimationEnd",c),d.addEventListener("webkitAnimationStart",u),a.switchPage(i,r,s)})}},function(){},!0)}return t.preventDefault()}}}),a.slice.call(i).forEach(function(e){e.getAttribute("data-title")||e.setAttribute("data-title",document.title)}),window.addEventListener("DOMContentLoaded",function(){0==t&&g.init()}),function(e,t){var a=e.documentElement,n="orientationchange"in window?"orientationchange":"resize",i=function(){var e=document.body.clientWidth;e&&(a.style.fontSize=20*(e/320)+"px")};e.addEventListener&&(i(),t.addEventListener(n,i,!1),e.addEventListener("DOMContentLoaded",i,!1))}(document,window),g});